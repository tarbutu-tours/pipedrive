# שלבים לפריסה – מפורט צעד אחר צעד

**הסדר הכולל:**  
**חלק א** → יש לך משהו שעובד על המחשב.  
**חלק ב** → שבוע בדיקות על מה שעובד.  
**חלק ג** → רק אחרי זה – העלאה לרשת ואייקון הבוט באתר.

---

# חלק א: להביא את הפרויקט למצב שעובד (מקומית)

**מטרה:** שבמחשב שלך יהיה שרת שרץ, לוח ניהול שנפתח, ובוט שמגיב – **כדי שיהיה על מה לבדוק** במשך השבוע.

---

## א1. קובץ .env (משתני סביבה)

1. בתיקייה `c:\Users\user\Documents\WORK\WEBTARBUTU` וודא שיש קובץ בשם **`.env`** (עם נקודה בהתחלה).
2. אם אין – העתק את הקובץ **`.env.example`** ושנה את השם ל-**`.env`**.
3. פתח את **`.env`** בעורך (Cursor / Notepad) והזן ערכים אמיתיים:
   - **OPENAI_API_KEY** – מפתח מ-OpenAI (https://platform.openai.com)
   - **SUPABASE_URL** ו-**SUPABASE_ANON_KEY** – מפרויקט Supabase שלך
   - **PIPEDRIVE_API_TOKEN** ו-**PIPEDRIVE_DOMAIN** – מ-Pipedrive
   - **AGENCY_NAME** – תרבותו
   - אם יש Monday / אימייל – מלא גם אותם
   - אם יש Twilio לווואטסאפ: **TWILIO_ACCOUNT_SID**, **TWILIO_AUTH_TOKEN**, **TWILIO_WHATSAPP_FROM** (למשל `whatsapp:+972501234567`)
4. שמור את הקובץ.

**סיום א1:** קובץ .env קיים ומלא (בלי להעלות אותו ל-Git).

---

## א2. טבלאות ב-Supabase

1. גלוש ל-**https://supabase.com** והתחבר.
2. בחר את הפרויקט שאליו שייכים ה-URL וה-Key שב-.env.
3. בתפריט השמאלי: **SQL Editor** → **New query**.
4. פתח אצלך את הקובץ **`WEBTARBUTU\database\schema.sql`**.
5. העתק את **כל** התוכן (Ctrl+A, Ctrl+C) והדבק בחלון השאילתה ב-Supabase.
6. לחץ **Run** (או Ctrl+Enter).
7. וודא שמופיע Success / שהשאילתה הסתיימה בלי שגיאות.

**סיום א2:** הטבלאות (chat_sessions, chat_messages, leads וכו') קיימות ב-Supabase.

---

## א3. התקנת חבילות והרצת השרת

1. פתח **PowerShell** (או Terminal ב-Cursor).
2. הקלד:
   ```powershell
   cd c:\Users\user\Documents\WORK\WEBTARBUTU
   npm install
   ```
   חכה עד שההתקנה מסתיימת (פעם ראשונה יכולה לקחת דקה).
3. אחר כך:
   ```powershell
   npm start
   ```
4. אמור להופיע משהו בסגנון:
   ```
   WEBTARBUTU server running at http://localhost:3000
   Admin: http://localhost:3000/admin
   ```
   אם יש Twilio – גם שורה על WhatsApp. אם אין Twilio – אולי יופיע QR (whatsapp-web.js).
5. **אל תסגור את החלון** – השרת צריך להישאר פתוח.

**סיום א3:** השרת רץ; הטרמינל פתוח עם הודעת "server running".

---

## א4. בדיקה שזה עובד – לוח ניהול וצ'אט

1. פתח **דפדפן** וגלוש ל: **http://localhost:3000/admin**  
   אמור להיטען לוח הניהול (פיד הודעות, לידים וכו').
2. בטאב נוסף פתח: **http://localhost:3000/widget-embed.html**  
   אמור להופיע בועת צ'אט; שלח "היי" – הבוט אמור לענות.
3. אם הבוט עונה – **יש לך משהו שעובד**. זה מה שתבדוק במשך השבוע.

**סיום א4:** לוח הניהול נפתח, והבוט מגיב בדף הבדיקה.

---

## א5. (אופציונלי) וואטסאפ מקומית עם Twilio

אם אתה רוצה לבדוק וואטסאפ **במהלך השבוע** כשהשרת רץ אצלך:

1. הורד **ngrok** מ-https://ngrok.com/download והרץ בטרמינל **נפרד**:  
   `ngrok http 3000`
2. העתק את כתובת ה-HTTPS שמופיעה (למשל `https://abc123.ngrok-free.app`).
3. ב-**Twilio Console** → המספר עם WhatsApp → **When a message comes in** הזן:  
   `https://abc123.ngrok-free.app/webhook/twilio/whatsapp`  
   POST → Save.
4. כל פעם שסוגרים ngrok ופותחים מחדש – הכתובת משתנה, ותצטרך לעדכן ב-Twilio (או לדלג על וואטסאפ עד הפריסה לרשת).

**סיום א5:** וואטסאפ מגיע ל-localhost דרך ngrok (או החלטת לדחות לשלב הפריסה).

---

**סיום חלק א:**  
על המחשב שלך רץ שרת, לוח הניהול עובד ב־http://localhost:3000/admin, והבוט מגיב ב־widget-embed.html. **זה "משהו שעובד"** – מכאן עוברים לחלק ב.

---

# חלק ב: שבוע בדיקות (על מה שעובד)

1. **כל פעם שאתה רוצה לבדוק** – הפעל את השרת (`cd WEBTARBUTU` → `npm start`) ופתח:
   - **http://localhost:3000/admin** – לוח ניהול
   - **http://localhost:3000/widget-embed.html** – צ'אט בוט
2. **מה לבדוק:**  
   שיחות מכירות (שם + טלפון → ליד ב-Pipedrive), תמיכה, השתלטות נציג מהלוח, וואטסאפ (אם הגדרת ב-א5).
3. **תעשה את זה במשך שבוע** – תתקן באגים, תוודא שהכל יציב.
4. **רק כשאתה מרוצה** – עוברים לחלק ג (פריסה לרשת).

**סיום חלק ב:** שבוע בדיקות הושלם; אתה מוכן להעלות לרשת.

---

# חלק ג: פריסה לרשת (רק אחרי חלק א + ב)

---

## שלב 1: חשבון GitHub (אם עדיין אין)

1. פתח דפדפן וגלוש ל־**https://github.com**
2. אם אין לך חשבון:
   - לחץ **Sign up**
   - הזן אימייל, סיסמה, שם משתמש
   - אשר את החשבון (אימייל אם נדרש)
3. אם יש חשבון – **Sign in** עם שם משתמש וסיסמה
4. וודא שאתה רואה את הדשבורד של GitHub (רשימת repositories או "Create repository")

**סיום השלב:** אתה מחובר ל-GitHub ורואה את המסך הראשי.

---

## שלב 2: יצירת מאגר (Repository) חדש ב-GitHub

1. בפינה **השמאלית העליונה** ליד הלוגו יש **"+"** – לחץ עליו
2. בתפריט בחר **New repository**
3. בשדה **Repository name** הקלד: `webtarbutu`  
   (או שם אחר – תזכור אותו להמשך)
4. **Description** – ריק או "בוט תרבותו"
5. בחר **Public**
6. **אל תסמן** תיבת "Add a README file"
7. השאר **Add .gitignore** ו-**Choose a license** ללא שינוי (או None)
8. לחץ **Create repository**
9. אחרי יצירת המאגר יופיעו הוראות "…or push an existing repository". **העתק** את הכתובת שמופיעה תחת "HTTPS", למשל:  
   `https://github.com/YourUsername/webtarbutu.git`  
   שמור אותה (פנקס / קובץ) – תשתמש בה בשלב 3.

**סיום השלב:** יש לך מאגר ריק ב-GitHub וכתובת HTTPS של המאגר.

---

## שלב 3: העלאת הקוד מהמחשב ל-GitHub

יש שתי אפשרויות – תלוי איפה נמצא ה-Git אצלך.

### אפשרות א: המאגר Git הוא בתיקייה WORK (כולל WEBTARBUTU)

1. פתח **PowerShell** (או Command Prompt)
2. הקלד:  
   `cd c:\Users\user\Documents\WORK`
3. בדוק אם WEBTARBUTU כבר חלק מהמאגר:  
   `git status`  
   אם אתה רואה קבצים מ-WEBTARBUTU (או את התיקייה) – המאגר הוא WORK
4. הוסף והעלה:  
   `git add .`  
   `git status`  
   (וודא ש-.env לא מופיע – הוא ב-.gitignore)
5. `git commit -m "Add WEBTARBUTU for deploy"`
6. אם עדיין לא חיברת את GitHub:  
   `git remote add origin https://github.com/שם-המשתמש-שלך/webtarbutu.git`  
   (החלף בכתובת מהשלב 2; אם כבר יש `origin` – דלג)
7. `git push -u origin main`  
   (אם הענף שלך נקרא `master`: `git push -u origin master` – ואז ב-Render תבחר Branch: master)
8. אם מתבקשת התחברות:
   - **Username:** שם המשתמש ב-GitHub
   - **Password:** אל תזין סיסמה – השתמש ב-**Personal Access Token**:  
     GitHub → Settings → Developer settings → Personal access tokens → Generate new token → סמן repo → העתק את ה-token והדבק ב-Password

**סיום השלב (אפשרות א):** ב-GitHub אתה רואה את כל הקבצים (כולל WEBTARBUTU). אם רק WORK הוא המאגר – תראה את כל תיקיות הפרויקט.

---

### אפשרות ב: רוצים ש-WEBTARBUTU יהיה מאגר נפרד ב-GitHub

1. פתח **PowerShell**
2. `cd c:\Users\user\Documents\WORK\WEBTARBUTU`
3. `git init`  
   (אם כבר יש .git – דלג)
4. `git add .`  
   `git status`  
   (וודא ש-.env לא ברשימה)
5. `git commit -m "WEBTARBUTU first deploy"`
6. `git branch -M main`
7. `git remote add origin https://github.com/שם-המשתמש-שלך/webtarbutu.git`  
   (הכתובת משלב 2)
8. `git push -u origin main`  
   (התחברות כמו באפשרות א – Token ב-Password)

**סיום השלב (אפשרות ב):** ב-GitHub במאגר webtarbutu אתה רואה רק את תוכן WEBTARBUTU (src, public, package.json וכו').

---

**אם אתה מעדיף GUI:**  
התקן **GitHub Desktop**, הוסף את התיקייה (WORK או WEBTARBUTU), עשה Commit ואז **Publish repository** או **Push origin**.

**סיום שלב 3:** הקוד מופיע ב-GitHub; .env לא עלה.

---

## שלב 4: חשבון Render

1. גלוש ל־**https://render.com**
2. לחץ **Get Started for Free**
3. בחר **Sign in with GitHub**
4. אם מתבקש – אשר גישה ל-Render (Authorize render)
5. אשר גישה ל-repositories (לפחות ל-webtarbutu)
6. אחרי ההתחברות תגיע ל-**Dashboard** של Render (רשימת שירותים, כרגע ריק)

**סיום השלב:** אתה בדשבורד Render, מחובר עם GitHub.

---

## שלב 5: יצירת ה-Web Service ב-Render

1. ב-Dashboard לחץ על **New +** (כפתור כחול)
2. בחר **Web Service**
3. אם מופיעה רשימת repositories:
   - אם **webtarbutu** לא מופיע – **Configure account** ובחר לאשר גישה ל-**webtarbutu** (או לארגון)
   - בחר את **webtarbutu** מהרשימה
   - לחץ **Connect**
4. מלא את השדות:
   - **Name:** `webtarbutu` (או שם אחר – זה השם בכתובת)
   - **Region:** בחר אזור קרוב (למשל **Frankfurt**)
   - **Branch:** `main` (או `master` אם זה הענף שלך)
   - **Root Directory:**  
     - אם המאגר מכיל **רק** את WEBTARBUTU (אפשרות ב בשלב 3) – **השאר ריק**  
     - אם המאגר הוא WORK ו-WEBTARBUTU היא תיקייה בפנים – כתוב: `WEBTARBUTU`
   - **Runtime:** **Node**
   - **Build Command:** `npm install`
   - **Start Command:** `npm start`
   - **Instance type:** **Free**
5. **אל תלחץ Create Web Service** – גלול למטה לשלב 6 (משתני סביבה).

**סיום השלב:** המסך מוכן, Root Directory ו-Branch נכונים.

---

## שלב 6: הוספת משתני הסביבה ב-Render

1. באותו מסך גלול לחלק **Environment Variables**
2. לחץ **Add Environment Variable**
3. הוסף **בנפרד** כל משתנה – **Key** ו-**Value** (העתק Value מהקובץ .env במחשב):

| Key | Value (מאיפה) |
|-----|----------------|
| NODE_ENV | `production` |
| OPENAI_API_KEY | מהקובץ .env |
| SUPABASE_URL | מהקובץ .env |
| SUPABASE_ANON_KEY | מהקובץ .env |
| PIPEDRIVE_API_TOKEN | מהקובץ .env |
| PIPEDRIVE_DOMAIN | מהקובץ .env |
| AGENCY_NAME | `תרבותו` או מהקובץ .env |
| TWILIO_ACCOUNT_SID | מהקובץ .env |
| TWILIO_AUTH_TOKEN | מהקובץ .env |
| TWILIO_WHATSAPP_FROM | מהקובץ .env (למשל `whatsapp:+972501234567`) |

4. אם אתה משתמש ב-Monday / אימייל / התראות – הוסף גם:  
   MONDAY_API_KEY, MONDAY_BOARD_ID, ALERT_EMAIL, SMTP_HOST, SMTP_PORT, SMTP_USER, SMTP_PASS (לפי מה שיש ב-.env)
5. **אל תוסיף** PORT – Render מגדיר אותו אוטומטית
6. אחרי כל זוג Key/Value – Add או Save
7. וודא שכל הערכים נכונים (בלי רווחים מיותרים בהתחלה/סוף)

**סיום השלב:** כל משתני ה-.env הרלוונטיים מופיעים ב-Environment Variables.

---

## שלב 7: Deploy – להריץ את הפרויקט ברשת

1. גלול למעלה ולחץ **Create Web Service**
2. Render יתחיל:
   - **Build** – מתקין חבילות (npm install), יכול לקחת 1–3 דקות
   - **Deploy** – מריץ את השרת
3. בראש הדף יש **Status**. חכה עד שיופיע **Live** (ירוק)
4. מתחת ל-Status תופיע **כתובת האתר**, למשל:  
   `https://webtarbutu-xxxx.onrender.com`
5. **העתק את הכתובת** ושמור במסמך / מועדפים – זו כתובת השרת שלך
6. **בדיקה:** פתח בדפדפן:  
   `https://הכתובת-שלך/health`  
   אמור להופיע: `{"ok":true,"timestamp":"..."}`  
   אם כן – השרת עובד ברשת.

**סיום השלב:** Status = Live, יש לך כתובת ושמורה, ו-/health מחזיר ok.

---

## שלב 8: Twilio – חיבור וואטסאפ לשרת ברשת

1. היכנס ל־**https://console.twilio.com**
2. בתפריט: **Messaging** → **Try it out** → **Send a WhatsApp message**  
   או: **Phone Numbers** → **Manage** → **Active numbers** → בחר את המספר עם WhatsApp
3. גלול לשדה **"When a message comes in"** (Webhook URL)
4. בשדה הכתובת הזן:  
   `https://הכתובת-מ-Render/webhook/twilio/whatsapp`  
   (החלף "הכתובת-מ-Render" בכתובת האמיתית משלב 7, בלי סלאש בסוף)
5. וודא ש-**HTTP** הוא **POST**
6. לחץ **Save**
7. שלח הודעת בדיקה לווואטסאפ של הבוט – התשובה אמורה להגיע מהשרת ברשת

**סיום השלב:** Webhook מצביע לכתובת Render; וואטסאפ מגיב דרך הרשת.

---

## שלב 9: לוח הניהול – גישה מהרשת

1. בדפדפן פתח:  
   `https://הכתובת-מ-Render/admin`  
   (אותה כתובת משלב 7 + `/admin`)
2. אמור להיטען לוח הניהול (כמו ב-localhost): פיד הודעות, לידים, השתלטות וכו'
3. הוסף למועדפים: "לוח ניהול תרבותו" – מכאן תנהל מהרשת מכל מכשיר

**סיום השלב:** אתה נכנס ל-/admin מהרשת ורואה את הלוח.

---

## שלב 10: אייקון הבוט באתר הרשמי (רק אחרי ששלבים 1–9 הושלמו)

1. וודא שהשרת Live ו-/admin עובד
2. הכן את הקוד להטמעה – **החלף** את הכתובות והמספר:

```html
<script>
  window.WEBTARBUTU_API = 'https://הכתובת-מ-Render';
  window.WEBTARBUTU_AGENCY = 'תרבותו';
  window.WEBTARBUTU_WHATSAPP_NUMBER = '972XXXXXXXXX';
</script>
<script src="https://הכתובת-מ-Render/widget.js" async></script>
```

- `הכתובת-מ-Render` – הכתובת משלב 7 (בלי סלאש בסוף)
- `972XXXXXXXXX` – מספר הוואטסאפ של המשרד (בלי +)

3. שלח את הבלוק למפתח האתר **tarbutu.co.il**
4. בקש ממנו להכניס את הקוד לכל עמוד (או ב-header/footer גלובלי) כך שיטען בכל דף
5. אחרי העלאה – גלוש לאתר הרשמי וודא שאייקון הבוט מופיע ולחיצה פותחת צ'אט שעובד

**סיום השלב:** הבוט מופיע באתר הרשמי ועובד דרך השרת ברשת.

---

## סיום – סיכום כתובות

| שימוש | כתובת |
|--------|--------|
| לוח ניהול | `https://הכתובת-שלך/admin` |
| בדיקת בריאות שרת | `https://הכתובת-שלך/health` |
| וידג'ט באתר | טוען מ-`https://הכתובת-שלך/widget.js` |
| Twilio Webhook | `https://הכתובת-שלך/webhook/twilio/whatsapp` |

אם נתקעת בשלב מסוים – ציין את **מספר השלב** ו**מה בדיוק קרה** (הודעת שגיאה או מה שאתה רואה במסך), ונמשיך משם.
