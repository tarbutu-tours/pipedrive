<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WEBTARBUTU Admin</title>
  <style>
    :root { --bg: #f5f5f5; --card: #fff; --text: #1a1a1a; --muted: #666; --accent: #1967d2; --danger: #c5221f; --success: #137333; }
    * { box-sizing: border-box; }
    body { font-family: system-ui, -apple-system, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 1rem; min-height: 100vh; }
    h1 { font-size: 1.5rem; margin: 0 0 1rem 0; }
    .toolbar { display: flex; gap: 1rem; align-items: center; margin-bottom: 1rem; flex-wrap: wrap; }
    .btn { padding: 0.5rem 1rem; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9rem; }
    .btn-pause { background: var(--danger); color: #fff; }
    .btn-resume { background: var(--success); color: #fff; }
    .btn-refresh { background: var(--card); color: var(--accent); border: 1px solid var(--accent); }
    .status { padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.85rem; }
    .status.paused { background: rgba(197,34,31,0.15); color: var(--danger); }
    .status.live { background: rgba(19,115,51,0.15); color: var(--success); }
    section { background: var(--card); border-radius: 8px; padding: 1rem; margin-bottom: 1rem; box-shadow: 0 1px 3px rgba(0,0,0,0.08); }
    section h2 { font-size: 1rem; margin: 0 0 0.75rem 0; color: var(--muted); }
    table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
    th, td { text-align: left; padding: 0.5rem 0.75rem; border-bottom: 1px solid rgba(0,0,0,0.08); }
    th { color: var(--muted); font-weight: 600; }
    .feed { max-height: 400px; overflow-y: auto; }
    .feed-item { padding: 0.5rem 0; border-bottom: 1px solid rgba(0,0,0,0.08); font-size: 0.85rem; }
    .feed-item .meta { color: var(--muted); margin-bottom: 0.25rem; }
    .feed-item .content { white-space: pre-wrap; word-break: break-word; }
    .feed-item.user .content { color: var(--accent); }
    .feed-item.assistant .content { color: var(--text); }
    .session-row { background: #f9f9f9 !important; border: 1px solid rgba(0,0,0,0.08) !important; }
    .session-row input { background: #fff !important; border: 1px solid #ccc !important; color: #1a1a1a !important; }
  </style>
</head>
<body>
  <h1>WEBTARBUTU Admin</h1>
  <div class="toolbar">
    <span id="pauseStatus" class="status live">Bot: Live</span>
    <button id="btnPause" class="btn btn-pause" type="button">Pause Bot</button>
    <button id="btnResume" class="btn btn-resume" type="button" style="display:none">Resume Bot</button>
    <button id="btnRefresh" class="btn btn-refresh" type="button">Refresh</button>
  </div>
  <section>
    <h2>Real-time chat feed</h2>
    <div id="feed" class="feed"></div>
  </section>
  <section>
    <h2>שיחות וואטסאפ – השתלטות נציג</h2>
    <p style="color:var(--muted);font-size:0.9rem;margin-bottom:0.75rem;">לחץ "השתלט" כדי לעצור את הבוט ולענות ידנית. שלח הודעה מהתיבה. "המשך בוט" מחזיר את הבוט.</p>
    <div id="sessionsList"></div>
  </section>
  <section>
    <h2>Leads (Name, Phone, Intent, CRM Status)</h2>
    <div style="overflow-x: auto;">
      <table>
        <thead>
          <tr>
            <th>Name</th>
            <th>Phone</th>
            <th>Intent</th>
            <th>CRM Status</th>
            <th>Summary</th>
            <th>UTM</th>
            <th>Date</th>
          </tr>
        </thead>
        <tbody id="leadsBody"></tbody>
      </table>
    </div>
  </section>
  <script>
    const API = window.location.origin;
    async function getPause() {
      const r = await fetch(API + '/api/admin/pause');
      const d = await r.json();
      return d.paused;
    }
    async function setPause(paused) {
      await fetch(API + '/api/admin/pause', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ paused }) });
      await updatePauseUI();
    }
    async function updatePauseUI() {
      const paused = await getPause();
      document.getElementById('pauseStatus').textContent = paused ? 'Bot: Paused' : 'Bot: Live';
      document.getElementById('pauseStatus').className = 'status ' + (paused ? 'paused' : 'live');
      document.getElementById('btnPause').style.display = paused ? 'none' : 'inline-block';
      document.getElementById('btnResume').style.display = paused ? 'inline-block' : 'none';
    }
    document.getElementById('btnPause').onclick = () => setPause(true);
    document.getElementById('btnResume').onclick = () => setPause(false);
    function renderFeed(messages) {
      const el = document.getElementById('feed');
      el.innerHTML = (messages || []).map(m => {
        const s = m.session || {};
        const meta = [s.channel, s.external_id, s.intent, m.created_at].filter(Boolean).join(' · ');
        return `<div class="feed-item ${m.role}"><div class="meta">${meta}</div><div class="content">${escapeHtml(m.content)}</div></div>`;
      }).join('');
    }
    function escapeHtml(s) {
      const div = document.createElement('div');
      div.textContent = s;
      return div.innerHTML;
    }
    function renderSessions(sessions) {
      const el = document.getElementById('sessionsList');
      if (!el) return;
      const wa = (sessions || []).filter(s => s.channel === 'whatsapp');
      if (!wa.length) { el.innerHTML = '<p style="color:var(--muted)">אין שיחות וואטסאפ.</p>'; return; }
      el.innerHTML = wa.map(s => {
        const paused = s.bot_paused_until && new Date(s.bot_paused_until) > new Date();
        const id = escapeHtml(s.id);
        const ext = escapeHtml(s.external_id);
        const name = escapeHtml(s.name || '-');
        return '<div class="session-row" style="margin-bottom:0.75rem;padding:0.5rem;border-radius:6px;">' +
          '<span style="margin-right:0.5rem;"><strong>' + ext + '</strong> ' + name + '</span>' +
          (paused ? '<span class="status paused" style="margin-right:0.5rem;">נציג</span>' : '') +
          '<button type="button" class="btn ' + (paused ? 'btn-resume' : 'btn-pause') + '" data-session-id="' + id + '" data-action="' + (paused ? 'resume' : 'takeover') + '" style="margin-right:0.5rem;">' + (paused ? 'המשך בוט' : 'השתלט') + '</button>' +
          '<input type="text" placeholder="הודעה ללקוח..." data-to="' + ext + '" style="padding:0.35rem 0.5rem;width:200px;margin-right:0.5rem;background:var(--bg);border:1px solid rgba(255,255,255,0.2);border-radius:4px;color:var(--text);" />' +
          '<button type="button" class="btn btn-refresh send-wa" data-to="' + ext + '">שלח</button>' +
          '</div>';
      }).join('');
      el.querySelectorAll('[data-action="takeover"]').forEach(btn => {
        btn.onclick = () => fetch(API + '/api/admin/session/' + btn.dataset.sessionId + '/takeover', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ pauseMinutes: 120 }) }).then(() => load());
      });
      el.querySelectorAll('[data-action="resume"]').forEach(btn => {
        btn.onclick = () => fetch(API + '/api/admin/session/' + btn.dataset.sessionId + '/resume', { method: 'POST' }).then(() => load());
      });
      el.querySelectorAll('.send-wa').forEach(btn => {
        btn.onclick = function() {
          const row = this.closest('.session-row');
          const input = row.querySelector('input[data-to]');
          const to = input.dataset.to;
          const msg = (input.value || '').trim();
          if (!msg) return;
          fetch(API + '/api/admin/whatsapp/send', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ to, message: msg }) })
            .then(r => r.json()).then(() => { input.value = ''; load(); });
        };
      });
    }
    function renderLeads(leads) {
      const tbody = document.getElementById('leadsBody');
      tbody.innerHTML = (leads || []).map(l => {
        const utm = [l.utm_source, l.utm_medium, l.utm_campaign].filter(Boolean).join(' ');
        const date = l.created_at ? new Date(l.created_at).toLocaleString() : '';
        return `<tr><td>${escapeHtml(l.name)}</td><td>${escapeHtml(l.phone)}</td><td>${l.intent || '-'}</td><td>${l.crm_status || 'new'}</td><td>${escapeHtml((l.chat_summary || '').slice(0, 80))}</td><td>${escapeHtml(utm)}</td><td>${date}</td></tr>`;
      }).join('');
    }
    async function load() {
      try {
        const [msgRes, leadsRes, sessionsRes] = await Promise.all([
          fetch(API + '/api/admin/messages?limit=50'),
          fetch(API + '/api/admin/leads?limit=100'),
          fetch(API + '/api/admin/sessions?limit=50'),
        ]);
        const msgData = await msgRes.json();
        const leadsData = await leadsRes.json();
        const sessionsData = await sessionsRes.json();
        renderFeed(msgData.messages || []);
        renderSessions(sessionsData.sessions || []);
        renderLeads(leadsData.leads || []);
      } catch (e) {
        console.error(e);
        document.getElementById('feed').innerHTML = '<div class="feed-item">Failed to load.</div>';
      }
    }
    document.getElementById('btnRefresh').onclick = load;
    updatePauseUI();
    load();
    setInterval(load, 15000);
  </script>
</body>
</html>
